<html>
    <meta chartset=UTF-8 />
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script> 
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
		<script src="..\node_modules\dist\plotly.min.js"></script>
		<iframe style="position: absolute; top: calc(25%); width: 45%; height: 50%; box-sizing: border-box; display: inline-block; float: left;" src="https://www.youtube.com/embed/_zsw4brbv18" frameborder="0" allow="accelerometer; autoplay; encrypted-meda; gyroscope; picture-in-picture" allowfullscreen></iframe>
		<div id="chart" style="position: absolute; top: calc(25%); left: calc(45%); display: inline-block; width: 45%; height: 25%; float: left;"></div>
		<div id="chart2" style="position: absolute; top: calc(50%); left: calc(45%); display: inline-block; width: 45%; height: 25%; float: left;"></div>
<script type="text/javascript">
let xhr = new XMLHttpRequest();
let data = {
    data: 0,
    time: new Date()
};
xhr.onreadystatechange = () => {
	if (xhr.readyState === xhr.DONE) {
        const newData = JSON.parse(xhr.responseText).data;
		if ((xhr.status === 200 || xhr.status === 201) && Date.parse(data.time) < Date.parse(newData.time)) {
			data = newData;
		}
	}
};
const getData = () => {
    xhr.open('POST', 'http://localhost:3000/sql');
    xhr.setRequestHeader('Content-type', 'application/json');
    xhr.send(JSON.stringify({
        sql: 'select * from test'
    }));
}
Plotly.plot('chart',[{
	x:[null],
    y:[null],
    type:'line',
    line: {
        color: "#ff0000"
    }
}]);
/*Plotly.plot('chart',[{
	x:[null],
    y:[getData()],
    type:'line'
}]);*/

Plotly.plot('chart2',[{
	x:[null],
    y:[null],
    type:'line',
    line: {
        color: "#ff0000"
    }
}]);
/*Plotly.plot('chart2',[{
	x:[null],
    y:[getData()],
    type:'line'
}]);*/

function httpGet(theUrl)
 {
 var xmlHttp= new XMLHttpRequest();
 xmlHttp.open("post", theUrl ,false);
 const sql="select * from realtime_result order by time DESC;";
 xmlHttp.setRequestHeader('Content-type','application/json')
 xmlHttp.send( JSON.stringify({sql}) );
 //console.log(JSON.stringify(sql))
 return xmlHttp.responseText;
 }
 //console.log(1234)
 //var test= httpGet("http://localhost:8080/sql");
 //console.log(test);
let cnt = 0;
let nowTime = 0;
setInterval(() => {
    cnt += 1;
    getData();
    const time = new Date(Date.parse(`${data.time}`.replace(/T|Z/, ' ').replace(/[-]/g,'/')));
	let update = {
        // x: [[time], [time]],
        // y: [[getData()], [getData()]]
        x: [[time]],
        y: [[data.data]]
    }
    if (nowTime < time.getTime()) {
        nowTime = time.getTime()
    }
	const olderTime = new Date(time.getTime() - 1000);
	const futureTime = new Date(time.getTime() + 1000);
	const minuteView = {
        xaxis: {
            type: 'date',
            range: [olderTime, futureTime]
        }
    };
    Plotly.relayout('chart', minuteView, color="#ffe476");
    Plotly.extendTraces('chart', update, [0]);
    Plotly.relayout('chart2', minuteView);
	Plotly.extendTraces('chart2', update, [0]);
}, 100);

</script>
    
</html>